C51 COMPILER V9.57.0.0   SGP30                                                             10/20/2020 17:22:57 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE SGP30
OBJECT MODULE PLACED IN .\Objects\SGP30.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE SGP30.c COMPACT OPTIMIZE(9,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\SGP30.lst) TABS(2) OBJECT(.\Objects\SGP30.obj)

line level    source

   1          #include "SGP30.H"
   2          
   3          void delay_ms_SGP(u16 ms)               
   4          {
   5   1        u16 a,b;
   6   1        for(a=ms;a>0;a--)
   7   1          for(b=114;b>0;b--);
   8   1      }
   9          
  10          //ģIICõĶʱ us
  11          
  12          void I2CDelay (u8 t)
  13          {
  14   1        while(t--);
  15   1      }
  16          
  17          //I2Cʼź
  18          void I2CStart(void)
  19          {
  20   1        SDA = 1;                            //ʼź 
  21   1        SCL = 1;
  22   1        I2CDelay(50);                    //ʼʱ4.7us,ʱ 
  23   1        SDA = 0;                            //ʼź
  24   1        I2CDelay(50);                    //ʼʱ4s 
  25   1        SCL = 0;                            //ǯסI2Cߣ׼ͻ 
  26   1        I2CDelay(50);
  27   1      }
  28          
  29          //I2Cֹͣź
  30          void I2CStop(void)
  31          {
  32   1        SDA = 0;                        //ͽź 
  33   1        SCL = 0;
  34   1        I2CDelay(50);
  35   1        SCL = 1;                        //ͽʱź 
  36   1        I2CDelay(50);                //ʱ4s 
  37   1        SDA = 1;                        //I2C߽ź 
  38   1        I2CDelay(50);
  39   1      }
  40          
  41          //I2CдһֽݣACKNACK
  42          u8 I2C_Write_Byte(u8 Write_Byte)  //Sendbyte
  43          {
  44   1        u8 i;
  45   1        SCL=0;
  46   1        I2CDelay(10);
  47   1        for(i=0; i<8; i++)            //Ҫ͵ݳΪ8λ 
  48   1        {
  49   2          if(Write_Byte&0x80)   //жϷλ 
  50   2          {
  51   3            SDA = 1;
  52   3          }
  53   2          else
  54   2          {
C51 COMPILER V9.57.0.0   SGP30                                                             10/20/2020 17:22:57 PAGE 2   

  55   3            SDA = 0;
  56   3          }
  57   2          I2CDelay(5);
  58   2          SCL=1;                //SDAȶSCLأӻ⵽ݲ
  59   2          I2CDelay(5);         //֤ʱӸߵƽڴ4s 
  60   2          SCL=0;
  61   2          I2CDelay(5);
  62   2          Write_Byte <<= 1;
  63   2        }
  64   1        I2CDelay(1);
  65   1        SDA = 1;                      //8λͷߣ׼Ӧλ-ZLG
  66   1        I2CDelay(40);
  67   1        SCL = 1;                      //MCU֪SHT2XݷϣȴӻӦź
  68   1        I2CDelay(40);
  69   1        /*жI2C߽ӦӦźACKNACK*/
  70   1        if(SDA==1)                                   //SDAΪߣյNACK
  71   1        {
  72   2          I2CDelay(40);
  73   2          SCL=0;
  74   2          return NACK;
  75   2        }
  76   1        else                                         //SDAΪͣյACK
  77   1        {
  78   2          I2CDelay(40);
  79   2          SCL=0;
  80   2          return ACK;
  81   2      
  82   2        }
  83   1      }
  84          
  85          //I2CһֽݣڲڿӦ״̬ACKNACK
  86          u8 I2C_Read_Byte(u8 AckValue)//receivebyte
  87          {
  88   1        u8 i,RDByte=0;
  89   1        SCL=0;                                   //ʱΪͣ׼λ 
  90   1        I2CDelay(40);
  91   1        SDA = 1;                                 //ͷ,Ϊ뷽ʽ 
  92   1        for (i=0; i<8; i++)
  93   1        {
  94   2          SCL = 1;                          //SCLߵƽڼ䣬ɼSDAźţΪЧ //ʱΪʹ
             -Ч 
  95   2          I2CDelay(20);
  96   2          RDByte <<= 1;                  //λ
  97   2          if(SDA==1)                           //ȡ
  98   2          {
  99   3            RDByte |= 0x01;
 100   3          }
 101   2          else
 102   2          {
 103   3            RDByte &= 0xfe;
 104   3          }
 105   2          I2CDelay(10);
 106   2          SCL = 0;                             //½أӻһλֵ
 107   2          I2CDelay(60);
 108   2        }
 109   1        /*I2C߷ӦźACKNACK*/
 110   1        SDA = AckValue;                      //Ӧ״̬
 111   1        I2CDelay(30);
 112   1        SCL = 1;
 113   1        I2CDelay(50);                  //ʱӵ͵ƽڴ4s 
 114   1        SCL = 0;                                  //ʱߣǯסI2CԱ 
 115   1        I2CDelay(150);
C51 COMPILER V9.57.0.0   SGP30                                                             10/20/2020 17:22:57 PAGE 3   

 116   1        return RDByte;
 117   1      }
 118          
 119          
 120          //ʼIICӿ
 121          void SGP30_Init(void)
 122          {
 123   1        SGP30_Write(0x20,0x03);
 124   1      }
 125          
 126          void SGP30_Write(u8 a, u8 b)
 127          {
 128   1        I2CStart();
 129   1        I2C_Write_Byte(SGP30_write); //ַ+дָ
 130   1        I2C_Write_Byte(a);    //Ϳֽ
 131   1        I2C_Write_Byte(b);
 132   1        I2CStop();
 133   1        delay_ms_SGP(100);
 134   1      }
 135          
 136          unsigned long SGP30_Read(void)
 137          {
 138   1        unsigned long dat;
 139   1        int crc;
 140   1        I2CStart();
 141   1        I2C_Write_Byte(SGP30_read); //ַ+ָ
 142   1        dat = I2C_Read_Byte(ACK);
 143   1        dat <<= 8;
 144   1        dat += I2C_Read_Byte(ACK);
 145   1        crc = I2C_Read_Byte(ACK); //checkݣȥ
 146   1        crc = crc;             //棬п
 147   1        dat <<= 8;
 148   1        dat += I2C_Read_Byte(ACK);
 149   1        dat <<= 8;
 150   1        dat += I2C_Read_Byte(NACK);
 151   1        I2CStop();
 152   1        return(dat);
 153   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    432    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----       4
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
